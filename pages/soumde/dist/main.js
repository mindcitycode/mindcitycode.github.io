(()=>{"use strict";const e=e=>()=>Object.values(e).forEach((e=>{e.disconnect&&e.disconnect(),e.stop&&e.stop()})),t=t=>{const n={osc:new OscillatorNode(t),gain:new GainNode(t)};return n.osc.connect(n.gain),n.gain.gain.value=0,n.osc.start(),{nodes:n,output:n.gain,remove:e(n)}},n=(e,t=[300,300])=>{const n=e.createAnalyser();n.fftSize=2048;const s=n.frequencyBinCount,o=new Uint8Array(s),a=document.createElement("canvas"),r=a.getContext("2d");return r.clearRect(0,0,a.width,a.height),(e=>{const t=()=>{const s=performance.now();e((s-n)/1e3,s/1e3),n=s,requestAnimationFrame(t)};let n=performance.now();requestAnimationFrame(t)})(((e,i)=>{a.width!==t[0]&&(a.width=t[0]),a.height!==t[1]&&(a.height=t[1]),n.getByteTimeDomainData(o),r.fillStyle="rgba(128,128,128,0.5)",r.fillRect(0,0,a.width,a.height),r.lineWidth=4,r.strokeStyle="black",r.beginPath();const c=a.width/s;let l=0;for(let e=0;e<s;e++){const t=o[e]/128*(a.height/2);0===e?r.moveTo(l,t):r.lineTo(l,t),l+=c}r.stroke()})),{nodes:{analyser:n},input:n,canvas:a,setSize:(e,n)=>{t[0]=e,t[1]=n}}},s=(e,t)=>{if(!e)throw new Error(t)},o=(e,t)=>{let n=0;for(let s=0;s<4;s++){const o=e[t+s];if(n|=127&o,!(128&o))return[n,s+1];n<<=7}},a=(e,t)=>{const n=o(e,t),s=n[0],a=t+n[1];return[e.slice(a,a+s),n[0]+n[1]]};[[0,[0]],[64,[64]],[127,[127]],[128,[129,0]],[8192,[192,0]],[16383,[255,127]],[16384,[129,128,0]],[1048576,[192,128,0]],[2097151,[255,255,127]],[2097152,[129,128,128,0]],[134217728,[192,128,128,0]],[268435455,[255,255,255,127]]].forEach((([e,t])=>{const[n,a]=o(t,0);s(n===e&&a===t.length,"reading of vlq is wrong")}));const r=(e,t,n)=>String.fromCharCode(...new Int8Array(e.slice(t,t+n))),i=(e,t)=>e.getUint32(t,false),c=(e,t)=>e.getUint16(t,false),l=document.createElement("pre");document.body.append(l),l.textContent="-",l.style="font-size : 10px";const u={0:"Sequence Number",1:"Text Event",2:"Copyright Notice",3:"Sequence/Track Name",4:"Instrument Name",5:"Lyric",6:"text Marker",7:"Cue Point",32:"MIDI Channel Prefix",47:"End of Track",81:"Set Tempo (in microseconds per MIDI quarter-note)",84:"SMPTE Offset",88:"Time Signature",89:"Key Signature",127:"Data Sequencer Specific Meta-Event"};class m{static oldAge=10;createFunction=void 0;synth=void 0;availableAfter=void 0;r=void 0;constructor(e,t,n){this.createFunction=e,this.synth=t,this.availableAfter=n,this.r=Math.random()}isAvailable(e,t){return this.createFunction===e&&void 0!==this.availableAfter&&t>this.availableAfter}notifyTimeOfUse(e){void 0===e?this.availableAfter=void 0:(void 0===this.availableAfter||e>this.availableAfter)&&(this.availableAfter=e)}isOldAndUseless(e){if(void 0===this.availableAfter)return!1;return e-this.availableAfter>m.oldAge}}const d=.02,h=.001,f=.15,g=.2,y=(e,t)=>(n,s,o)=>{e.cancelScheduledValues(n),t.cancelScheduledValues(n);const a=(r=s,440*Math.pow(2,(r-69)/12));var r;e.setValueAtTime(a,n),t.setValueAtTime(0,n);const i=n+d;t.linearRampToValueAtTime(o,i);const c=i+h,l=o*f;return t.linearRampToValueAtTime(l,c),{hold:{time:c,gain:l,frequency:a}}},p=(e,t)=>{const n=(e=>{const t=1/e.sampleRate,n=[];return{getSynth:(s,o)=>{const a=n.find((e=>e.isAvailable(s,o)));if(a)return{reused:!0,synthInUse:a};{const a=s(e),r=new m(s,a,o-t);return n.push(r),{reused:!1,synthInUse:r}}},_stats:()=>n,removeOldAndUseless:e=>{const t=n.findIndex((t=>t.isOldAndUseless(e)));if(-1!==t){const e=n[t];return n.splice(t,1),e.synth.remove&&e.synth.remove(),e}}}})(e),s=(e=>{const t=[];return{findAndRemove:(e,n,s)=>{const o=t.findIndex((t=>t.createFunction===e&&t.key===s&&t.channel===n));if(-1!==o){const e=t[o];return t.splice(o,1),e}console.error("no matching noteOn for",e,s)},set:(e,n,s,o,a)=>{t.push({createFunction:e,channel:n,key:s,playedNoteOn:o,synthInUse:a})},_checkEmpty:()=>{if(t.length)throw new Error("the cache should be empty")}}})();return{multiNoteOn:(e,o,a,r,i)=>{const{reused:c,synthInUse:l}=n.getSynth(e,o),u=l.synth;!1===c&&u.output.connect(t);const m=y(u.nodes.osc.frequency,u.nodes.gain.gain)(o,r,i);l.notifyTimeOfUse(void 0),s.set(e,a,r,m,l)},multiNoteOff:(e,t,n,o,a)=>{const r=s.findAndRemove(e,n,o),i=r.synthInUse,c=r.synthInUse.synth,l=(u=c.nodes.osc.frequency,m=c.nodes.gain.gain,(e,t,n,s)=>{u.cancelScheduledValues(t),m.cancelScheduledValues(t),u.setValueAtTime(e.hold.frequency,t),m.linearRampToValueAtTime(e.hold.gain,t);const o=t+g;return m.linearRampToValueAtTime(0,o),{end:o}});var u,m;const d=l(r.playedNoteOn,t,o,a);i.notifyTimeOfUse(d.end)},synthPool:n,noteOnCache:s}};(async()=>{const e=await(async e=>{const t=await fetch(e).then((e=>e.arrayBuffer())),n=e=>{const t=new Uint8Array(e),n=[];let s,r=0;for(;r<t.byteLength;){const e={};e["@offset"]=r;const i=o(t,r),c=i[0];let l;r+=i[1],e.deltaTime=c;let m=t[r];128&m?(l=m,s=l,r+=1,e["@runningStatus"]=!1):(l=s,e["@runningStatus"]=!0);const d=l>>>4&7,h=15&l;if(d<7)switch(e.isChannelVoiceMessage=!0,e.channel=h,d){case 0:{e.messageType="noteOff";const n=127&t[r],s=127&t[r+1];r+=2,e.key=n,e.velocity=s;break}case 1:{e.messageType="noteOn";const n=127&t[r],s=127&t[r+1];r+=2,e.key=n,e.velocity=s;break}case 2:{e.messageType="Polyphonic Key Pressure (Aftertouch)";const n=127&t[r],s=127&t[r+1];r+=2,e.key=n,e.pressureValue=s;break}case 3:{e.isChannelModeMessage=!0,e.messageType="control change, but also Channel Mode Message";const n=127&t[r],s=127&t[r+1];e.controllerNumber=n,e.newValue=s,r+=2}case 4:{e.messageType="program change";const n=127&t[r];r+=1,e.programNumber=n;break}case 5:{e.messageType="Channel Pressure (After-touch)";const n=127&t[r];r+=1,e.pressureValue=n;break}case 6:{e.messageType="Pitch Wheel Change";const n=127&t[r],s=127&t[r+1];r+=2,e.lsb=n,e.msb=s;break}}else if(7===d)if(15===h){e.isMetaEvent=!0,e.isSystemRealtimeMessage=!0;const n={},s=t[r];r+=1,n.type=s,n.typeString=u[s];const o=a(t,r);n.maybeText=String.fromCharCode(...o[0]),n.bytes=o[0],r+=o[1],e.metaEvent=n}else if(h<8)switch(e.isSystemCommonMessage=!0,h){case 0:{e.systemCommonMessage="System Exclusive";const n=a(t,r);r+=n[1],e.sysexBytes=n[0];break}case 1:e.systemCommonMessage="Undefined";break;case 2:e.systemCommonMessage="Song Position Pointer",t[r],t[r+1],r+=2;break;case 3:e.systemCommonMessage="Song Select",t[r],r+=2;break;case 4:case 5:e.systemCommonMessage="System Exclusive";break;case 6:e.systemCommonMessage="Tune Request";break;case 7:{e.systemCommonMessage="End Of Exclusive";const n=a(t,r);r+=n[1],e.sysexBytes=n[0];break}}else switch(e.isSystemRealtimeMessage=!0,h){case 8:e.realtimeMessage="Timing Clock";break;case 9:case 13:e.realtimeMessage="Undefined";break;case 10:e.realtimeMessage="Start";break;case 11:e.realtimeMessage="Continue";break;case 12:e.realtimeMessage="Stop";break;case 14:e.realtimeMessage="Active Sensing";break;default:throw new Error("wrong system realtime message"+JSON.stringify({byte1Right:h,byte1Left:d}))}n.push(e)}return n},l=(e=>{const t=new DataView(e);s("MThd"===r(e,0,4),"not a midi file"),s(6===i(t,4),"Wrong MThd length");const n=c(t,8),o=c(t,10),a=c(t,12),l=a>>>15;let u,m,d;return l?(m=a>>>8&127,d=127&a):u=a,{format:n,ntrks:o,division:a,bit15:l,ticksPerQuarterNote:u,timeCodeFormat:m,ticksPerFrame:d}})(t.slice(0)),m=((e,t)=>{const o=[];let a=0;for(let c=0;c<e.ntrks;c++){const e=new DataView(t,a);s("MTrk"===r(t,a,4),"not a midi track");const c=i(e,4),l=a+8;o.push(n(t.slice(l,l+c))),a=l+c}return o})(l,t.slice(14));return{header:l,tracks:m}})("assets/bwv812.mid");console.log("midiPart",e);const l=(({header:e,tracks:t})=>{if(void 0===e.ticksPerQuarterNote)throw new Error("cannot sequence timecode midi");const n=e.ticksPerQuarterNote,s=e=>"noteOn"===e.messageType,o=(e,t)=>e/t/1e6,a=[];t.forEach((e=>{let t=0;e.forEach((e=>{if(t+=e.deltaTime,(e=>e.metaEvent?.typeString?.startsWith("Set Tempo"))(e)){const[s,r,i]=e.metaEvent.bytes,c=s<<16|r<<8|i;a.push([t,c]),console.log(o(c,n))}}))})),a.sort(((e,t)=>[e[0]-t[0]])),a.forEach((e=>{const[t,n]=e})),console.log("tempoMap",a);const r=o(a[0][1],n),i=[];return t.forEach((e=>{const t=[];let n=0,o=0;e.forEach((e=>{if(o+=e.deltaTime,s(e)||(e=>"noteOff"===e.messageType)(e)){const a=o*r,i=a-n;t.push([i,s(e)?"on":"off",e.channel,e.key,e.velocity/127]),n=a}})),i.push(t)})),i})(e);console.log("parts",l);const m=new AudioContext;((e,t=document.body)=>{const n=document.createElement("button");n.style="font-size : 50px ; width : 300px; height : 300px; border : 10px solid black ; border-radius : 20px;\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    opacity:95%;\n    transform: translate(-50%, -50%);",n.onclick=()=>{"running"===e.state?e.suspend():"suspended"===e.state&&e.resume()};const s=()=>{n.textContent=e.state,n.style["background-color"]={running:"green",suspended:"orange"}[e.state]};s(),e.addEventListener("statechange",s),t.append(n)})(m),await m.resume();const d=function(e){const t={gain:e.createGain(),hp:e.createBiquadFilter(),lp:e.createBiquadFilter(),comp:e.createDynamicsCompressor(),master:e.createGain()};return t.gain.gain.value=1,t.hp.type="highpass",t.hp.frequency.value=20,t.lp.type="lowpass",t.lp.frequency.value=15e3,t.master.gain.value=0,t.gain.connect(t.lp).connect(t.hp).connect(t.comp).connect(t.master),{nodes:t,input:t.gain,output:t.master}}(m);d.output.connect(m.destination),d.output.gain.value=.5;const h=d.input,f=n(m);d.output.connect(f.input);const g=f.canvas;document.body.append(g),g.style="position:fixed;top:0;left:0;z-index:-5",onresize=()=>f.setSize(window.innerWidth,window.innerHeight),onresize();const{multiNoteOn:y,multiNoteOff:v,synthPool:b,noteOnCache:k}=p(m,h);const T=m.currentTime+1;l.forEach((e=>function(e,n){let s=e;n.forEach((e=>{const[n,o,a,r,i]=e;s+=n,"on"===o?y(t,s,a,r,i):"off"===o&&v(t,s,a,r,i)}))}(T,e))),k._checkEmpty(),console.log("pool stats",b._stats()),setInterval((()=>{const e=b.removeOldAndUseless(m.currentTime);e&&console.log("i did remove",e)}),1e3)})()})();